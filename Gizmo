-- gizmo.lua
-- Drawing API reimplementation of BradSharp's Gizmo module

local gizmo = {}

local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera

-- CONFIG
local POINT_SCALE = 5
local DEFAULT_COLOR = Color3.fromRGB(0, 255, 0)
local DEFAULT_THICKNESS = 2
local DEFAULT_SCALE = 1

-- INTERNAL STATE
local color = DEFAULT_COLOR
local transparency = 0
local thickness = DEFAULT_THICKNESS
local globalScale = DEFAULT_SCALE
local globalOrigin = CFrame.new()

local drawings = {}
local free = {}

local function newDrawing(typeName)
    -- protected creation: if the executor doesn't support a type, return nil
    local ok, obj = pcall(function() return Drawing.new(typeName) end)
    if not ok or not obj then
        return nil
    end
    -- set safe defaults
    if obj.Visible ~= nil then obj.Visible = false end
    if obj.Color ~= nil then obj.Color = color end
    if obj.Transparency ~= nil then obj.Transparency = 1 - transparency end
    if obj.Thickness ~= nil then obj.Thickness = thickness end
    obj.__type = typeName
    return obj
end

local function getDrawing(typeName)
    -- try reuse
    for i = #free, 1, -1 do
        local d = free[i]
        if d and d.__type == typeName then
            table.remove(free, i)
            return d
        end
    end
    -- try create
    return newDrawing(typeName)
end

local function releaseAll()
	for _, d in ipairs(drawings) do
		d.Visible = false
		table.insert(free, d)
	end
	table.clear(drawings)
end

-- Projection helper
local function project(pos)
	local v3, onScreen = Camera:WorldToViewportPoint(pos)
	return Vector2.new(v3.X, v3.Y), onScreen and v3.Z > 0
end

-- Utility for drawing lines
local function drawLine3D(a, b)
	local p1, ok1 = project(a)
	local p2, ok2 = project(b)
	if not (ok1 and ok2) then return end
	local line = getDrawing("Line")
	line.From = p1
	line.To = p2
	line.Thickness = thickness
	line.Color = color
	line.Transparency = 1 - transparency
	line.Visible = true
	table.insert(drawings, line)
end

------------------------------------------------------------------------------------------------------------------------
-- Exports (same API as original)
------------------------------------------------------------------------------------------------------------------------

function gizmo.setColor(c)
	if typeof(c) == "BrickColor" then
		color = c.Color
	elseif typeof(c) == "Color3" then
		color = c
	else
		color = DEFAULT_COLOR
	end
end

function gizmo.setColor3(c)
	color = c
end

function gizmo.setOrigin(cf)
	globalOrigin = cf
end

function gizmo.setTransparency(t)
	transparency = math.clamp(t or 0, 0, 1)
end

function gizmo.setLayer(_) end -- Not supported in Drawing

function gizmo.setScale(s)
	globalScale = s or 1
end

function gizmo.reset()
	color = DEFAULT_COLOR
	thickness = DEFAULT_THICKNESS
	globalScale = DEFAULT_SCALE
	globalOrigin = CFrame.new()
	transparency = 0
end

------------------------------------------------------------------------------------------------------------------------
-- DRAW FUNCTIONS
------------------------------------------------------------------------------------------------------------------------

function gizmo.drawPoint(pos)
	local p, ok = project(globalOrigin:PointToWorldSpace(pos))
	if not ok then return end
	local c = getDrawing("Circle")
	c.Position = p
	c.Radius = globalScale * thickness * POINT_SCALE
	c.Filled = true
	c.Color = color
	c.Transparency = 1 - transparency
	c.Visible = true
	table.insert(drawings, c)
end

function gizmo.drawLine(from, to)
	from = globalOrigin:PointToWorldSpace(from)
	to = globalOrigin:PointToWorldSpace(to)
	drawLine3D(from, to)
end

function gizmo.drawArrow(from, to)
    from = globalOrigin:PointToWorldSpace(from)
    to = globalOrigin:PointToWorldSpace(to)

    -- draw main line (uses Line which is widely supported)
    do
        local p1, ok1 = project(from)
        local p2, ok2 = project(to)
        if ok1 and ok2 then
            local line = getDrawing("Line")
            if line then
                line.From = p1
                line.To = p2
                if line.Thickness ~= nil then line.Thickness = thickness end
                if line.Color ~= nil then line.Color = color end
                if line.Transparency ~= nil then line.Transparency = 1 - transparency end
                line.Visible = true
                table.insert(drawings, line)
            end
        end
    end

    -- draw arrowhead (Triangle may not be available in all executors; guard it)
    do
        local p1, ok1 = project(from)
        local p2, ok2 = project(to)
        if not (ok1 and ok2) then return end

        local dirVec = (p2 - p1)
        if dirVec.Magnitude <= 0 then return end
        local dir = dirVec.unit
        local left = Vector2.new(-dir.Y, dir.X)
        local size = math.min(16, dirVec.Magnitude * 0.2 + 8) * globalScale

        local tri = getDrawing("Triangle")
        if tri then
            tri.PointA = p2
            tri.PointB = p2 - dir * size + left * (size * 0.6)
            tri.PointC = p2 - dir * size - left * (size * 0.6)
            if tri.Filled ~= nil then tri.Filled = true end
            if tri.Color ~= nil then tri.Color = color end
            if tri.Transparency ~= nil then tri.Transparency = 1 - transparency end
            tri.Visible = true
            table.insert(drawings, tri)
            return
        end

        -- fallback: draw a small V with two Lines if Triangle not available
        local l1 = getDrawing("Line")
        local l2 = getDrawing("Line")
        if l1 and l2 then
            l1.From = p2
            l1.To = p2 - dir * size + left * (size * 0.6)
            l2.From = p2
            l2.To = p2 - dir * size - left * (size * 0.6)
            if l1.Thickness ~= nil then l1.Thickness = thickness end
            if l2.Thickness ~= nil then l2.Thickness = thickness end
            if l1.Color ~= nil then l1.Color = color end
            if l2.Color ~= nil then l2.Color = color end
            if l1.Transparency ~= nil then l1.Transparency = 1 - transparency end
            if l2.Transparency ~= nil then l2.Transparency = 1 - transparency end
            l1.Visible = true
            l2.Visible = true
            table.insert(drawings, l1)
            table.insert(drawings, l2)
        end
    end
end


function gizmo.drawRay(from, dir)
	gizmo.drawArrow(from, from + dir)
end

function gizmo.drawBox(orientation, size)
	local cf = globalOrigin * orientation
	local sx, sy, sz = size.X / 2, size.Y / 2, size.Z / 2
	local corners = {
		Vector3.new( sx, sy, sz),
		Vector3.new(-sx, sy, sz),
		Vector3.new(-sx,-sy, sz),
		Vector3.new( sx,-sy, sz),
		Vector3.new( sx, sy,-sz),
		Vector3.new(-sx, sy,-sz),
		Vector3.new(-sx,-sy,-sz),
		Vector3.new( sx,-sy,-sz)
	}
	for i, v in ipairs(corners) do
		corners[i] = cf:PointToWorldSpace(v)
	end
	local edges = {
		{1,2},{2,3},{3,4},{4,1},
		{5,6},{6,7},{7,8},{8,5},
		{1,5},{2,6},{3,7},{4,8}
	}
	for _, e in ipairs(edges) do
		drawLine3D(corners[e[1]], corners[e[2]])
	end
end

function gizmo.drawWireBox(orientation, size)
	gizmo.drawBox(orientation, size)
end

function gizmo.drawSphere(cf, radius)
	local center = globalOrigin * cf
	local pos = center.Position
	local p, ok = project(pos)
	if not ok then return end
	local offset = Camera.CFrame.RightVector * radius
	local pr, okr = project(pos + offset)
	if not okr then return end
	local r = (p - pr).Magnitude
	local circle = getDrawing("Circle")
	circle.Position = p
	circle.Radius = r
	circle.NumSides = 32
	circle.Color = color
	circle.Thickness = thickness
	circle.Filled = false
	circle.Transparency = 1 - transparency
	circle.Visible = true
	table.insert(drawings, circle)
end

function gizmo.drawWireSphere(cf, radius)
	local c = globalOrigin * cf
	local pos = c.Position
	local axes = {
		CFrame.Angles(0,0,0),
		CFrame.Angles(math.pi/2,0,0),
		CFrame.Angles(0,math.pi/2,0)
	}
	for _, rot in ipairs(axes) do
		local p, ok = project(pos)
		local offset = (c * rot).RightVector * radius
		local pr, okr = project(pos + offset)
		if ok and okr then
			local r = (p - pr).Magnitude
			local circle = getDrawing("Circle")
			circle.Position = p
			circle.Radius = r
			circle.NumSides = 64
			circle.Color = color
			circle.Thickness = thickness
			circle.Filled = false
			circle.Transparency = 1 - transparency
			circle.Visible = true
			table.insert(drawings, circle)
		end
	end
end

function gizmo.drawText(pos, text)
	local p, ok = project(globalOrigin:PointToWorldSpace(pos))
	if not ok then return end
	local t = getDrawing("Text")
	t.Text = tostring(text)
	t.Size = 16
	t.Center = true
	t.Outline = true
	t.Color = color
	t.Transparency = 1 - transparency
	t.Position = p
	t.Visible = true
	table.insert(drawings, t)
end

function gizmo.clear()
	releaseAll()
end

------------------------------------------------------------------------------------------------------------------------
-- RENDER LOOP
------------------------------------------------------------------------------------------------------------------------

RunService.RenderStepped:Connect(function()
	releaseAll()
end)

------------------------------------------------------------------------------------------------------------------------

return gizmo
