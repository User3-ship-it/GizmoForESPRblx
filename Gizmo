-- gizmo.lua
-- Drawing API reimplementation of BradSharp's Gizmo module

local gizmo = {}

local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera

-- CONFIG
local POINT_SCALE = 5
local DEFAULT_COLOR = Color3.fromRGB(0, 255, 0)
local DEFAULT_THICKNESS = 2
local DEFAULT_SCALE = 1

-- INTERNAL STATE
local color = DEFAULT_COLOR
local transparency = 0
local thickness = DEFAULT_THICKNESS
local globalScale = DEFAULT_SCALE
local globalOrigin = CFrame.new()

local drawings = {}
local free = {}

local function newDrawing(typeName)
	local obj = Drawing.new(typeName)
	obj.Visible = false
	obj.Color = color
	obj.Transparency = 1 - transparency
	obj.ZIndex = 1
	if typeName == "Line" then obj.Thickness = thickness end
	obj.__type = typeName
	return obj
end

local function getDrawing(typeName)
	for i, d in ipairs(free) do
		if d.__type == typeName then
			table.remove(free, i)
			return d
		end
	end
	return newDrawing(typeName)
end

local function releaseAll()
	for _, d in ipairs(drawings) do
		d.Visible = false
		table.insert(free, d)
	end
	table.clear(drawings)
end

-- Projection helper
local function project(pos)
	local v3, onScreen = Camera:WorldToViewportPoint(pos)
	return Vector2.new(v3.X, v3.Y), onScreen and v3.Z > 0
end

-- Utility for drawing lines
local function drawLine3D(a, b)
	local p1, ok1 = project(a)
	local p2, ok2 = project(b)
	if not (ok1 and ok2) then return end
	local line = getDrawing("Line")
	line.From = p1
	line.To = p2
	line.Thickness = thickness
	line.Color = color
	line.Transparency = 1 - transparency
	line.Visible = true
	table.insert(drawings, line)
end

------------------------------------------------------------------------------------------------------------------------
-- Exports (same API as original)
------------------------------------------------------------------------------------------------------------------------

function gizmo.setColor(c)
	if typeof(c) == "BrickColor" then
		color = c.Color
	elseif typeof(c) == "Color3" then
		color = c
	else
		color = DEFAULT_COLOR
	end
end

function gizmo.setColor3(c)
	color = c
end

function gizmo.setOrigin(cf)
	globalOrigin = cf
end

function gizmo.setTransparency(t)
	transparency = math.clamp(t or 0, 0, 1)
end

function gizmo.setLayer(_) end -- Not supported in Drawing

function gizmo.setScale(s)
	globalScale = s or 1
end

function gizmo.reset()
	color = DEFAULT_COLOR
	thickness = DEFAULT_THICKNESS
	globalScale = DEFAULT_SCALE
	globalOrigin = CFrame.new()
	transparency = 0
end

------------------------------------------------------------------------------------------------------------------------
-- DRAW FUNCTIONS
------------------------------------------------------------------------------------------------------------------------

function gizmo.drawPoint(pos)
	local p, ok = project(globalOrigin:PointToWorldSpace(pos))
	if not ok then return end
	local c = getDrawing("Circle")
	c.Position = p
	c.Radius = globalScale * thickness * POINT_SCALE
	c.Filled = true
	c.Color = color
	c.Transparency = 1 - transparency
	c.Visible = true
	table.insert(drawings, c)
end

function gizmo.drawLine(from, to)
	from = globalOrigin:PointToWorldSpace(from)
	to = globalOrigin:PointToWorldSpace(to)
	drawLine3D(from, to)
end

function gizmo.drawArrow(from, to)
	from = globalOrigin:PointToWorldSpace(from)
	to = globalOrigin:PointToWorldSpace(to)
	drawLine3D(from, to)

	local p1, ok1 = project(from)
	local p2, ok2 = project(to)
	if not (ok1 and ok2) then return end

	local dir = (p2 - p1).unit
	local left = Vector2.new(-dir.Y, dir.X)
	local size = 6 * globalScale
	local tri = getDrawing("Triangle")
	tri.PointA = p2
	tri.PointB = p2 - dir * size + left * (size * 0.6)
	tri.PointC = p2 - dir * size - left * (size * 0.6)
	tri.Color = color
	tri.Filled = true
	tri.Transparency = 1 - transparency
	tri.Visible = true
	table.insert(drawings, tri)
end

function gizmo.drawRay(from, dir)
	gizmo.drawArrow(from, from + dir)
end

function gizmo.drawBox(orientation, size)
	local cf = globalOrigin * orientation
	local sx, sy, sz = size.X / 2, size.Y / 2, size.Z / 2
	local corners = {
		Vector3.new( sx, sy, sz),
		Vector3.new(-sx, sy, sz),
		Vector3.new(-sx,-sy, sz),
		Vector3.new( sx,-sy, sz),
		Vector3.new( sx, sy,-sz),
		Vector3.new(-sx, sy,-sz),
		Vector3.new(-sx,-sy,-sz),
		Vector3.new( sx,-sy,-sz)
	}
	for i, v in ipairs(corners) do
		corners[i] = cf:PointToWorldSpace(v)
	end
	local edges = {
		{1,2},{2,3},{3,4},{4,1},
		{5,6},{6,7},{7,8},{8,5},
		{1,5},{2,6},{3,7},{4,8}
	}
	for _, e in ipairs(edges) do
		drawLine3D(corners[e[1]], corners[e[2]])
	end
end

function gizmo.drawWireBox(orientation, size)
	gizmo.drawBox(orientation, size)
end

function gizmo.drawSphere(cf, radius)
	local center = globalOrigin * cf
	local pos = center.Position
	local p, ok = project(pos)
	if not ok then return end
	local offset = Camera.CFrame.RightVector * radius
	local pr, okr = project(pos + offset)
	if not okr then return end
	local r = (p - pr).Magnitude
	local circle = getDrawing("Circle")
	circle.Position = p
	circle.Radius = r
	circle.NumSides = 32
	circle.Color = color
	circle.Thickness = thickness
	circle.Filled = false
	circle.Transparency = 1 - transparency
	circle.Visible = true
	table.insert(drawings, circle)
end

function gizmo.drawWireSphere(cf, radius)
	local c = globalOrigin * cf
	local pos = c.Position
	local axes = {
		CFrame.Angles(0,0,0),
		CFrame.Angles(math.pi/2,0,0),
		CFrame.Angles(0,math.pi/2,0)
	}
	for _, rot in ipairs(axes) do
		local p, ok = project(pos)
		local offset = (c * rot).RightVector * radius
		local pr, okr = project(pos + offset)
		if ok and okr then
			local r = (p - pr).Magnitude
			local circle = getDrawing("Circle")
			circle.Position = p
			circle.Radius = r
			circle.NumSides = 64
			circle.Color = color
			circle.Thickness = thickness
			circle.Filled = false
			circle.Transparency = 1 - transparency
			circle.Visible = true
			table.insert(drawings, circle)
		end
	end
end

function gizmo.drawText(pos, text)
	local p, ok = project(globalOrigin:PointToWorldSpace(pos))
	if not ok then return end
	local t = getDrawing("Text")
	t.Text = tostring(text)
	t.Size = 16
	t.Center = true
	t.Outline = true
	t.Color = color
	t.Transparency = 1 - transparency
	t.Position = p
	t.Visible = true
	table.insert(drawings, t)
end

function gizmo.clear()
	releaseAll()
end

------------------------------------------------------------------------------------------------------------------------
-- RENDER LOOP
------------------------------------------------------------------------------------------------------------------------

RunService.RenderStepped:Connect(function()
	releaseAll()
end)

------------------------------------------------------------------------------------------------------------------------

return gizmo
